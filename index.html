<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://duanyu5871.github.io/virtualButton/javascripts/virtualButtonManager.js"> </script>
    <title>虚拟触控按钮</title>
    <style>
        body {
            position: relative;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            /* 禁止文本选择 */
        }

        .editor {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
        }

        #gameFrame {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            margin: 0;
            padding-top: 0px;
            padding-bottom: 0px;
        }
    </style>
</head>

<body>

    <div class="editor">
        <button id="loadBtn">加载按键(load settings)</button>
        <button id="editBtn">编辑(edit mode)</button>
        <button id="generateBtn">文本生成(generate)</button>
        <button id="exportBtn">导出(export)</button>
        <button id="importBtn">导入(import)</button>
        <button id="fullScreenBtn">全屏(fullscreen)</button>
        <button id="fullScreenLandBtn">横向全屏(手机用)(fullscreen landscape)</button>
    </div>

    <div>
        <iframe src="./sdlMS_online/sdlMS.html" id="gameFrame"> 123 </iframe>
    </div>

    <script>
        function fullsc(flag = 0) {
            var docElm = window.wrap;
            try {
                docElm.requestFullscreen();
            } catch { console.log("full_mode1 error") }

            try {
                docElm.mozRequestFullScreen();
            } catch { console.log("full_mode2 error") }

            try {
                docElm.webkitRequestFullscreen();
            } catch { console.log("full_mode3 error") }

            try {
                docElm.webkitEnterFullScreen();
            } catch { console.log("full_mode4 error") }
            if (flag) {
                lockScreenInLandscape()
                adjustCanvasSize(); // 全屏后调整尺寸
                window.wrap.style.width = '100%'
                window.wrap.style.height = '100%'
                window.game.style.width = '100%'
                window.game.style.height = '100%'
            };
        }

        function lockScreenInLandscape() {
            if (!('orientation' in screen)) {
                return;
            }

            if (matchMedia('(orientation: portrait) and (max-device-width: 768px)').matches) {
                screen.orientation.lock('landscape');
            }
        }

        // 监听全屏状态变化
        function onFullScreenChange() {
            if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                console.log('退出了全屏模式');
            } else {
                console.log('进入了全屏模式');
            }
        }

        function adjustCanvasSize() {
            // 根据父元素的实际尺寸设置Canvas的像素尺寸
            window.game.width = window.wrap.clientWidth;
            window.game.height = window.wrap.clientHeight;
            // 若游戏有渲染缩放，需在此触发重绘或调整
            console.log('Canvas尺寸调整为:', window.game.width, window.game.height);
        }

        function sendVirtualKey(keyState, code) {
            const object = window.game;
            var oEvent = new KeyboardEvent(keyState, {
                bubbles: true,
                key: code,
                code: code
            });
            object.dispatchEvent(oEvent);
        }

        // 监听全屏变化事件
        document.addEventListener('fullscreenchange', onFullScreenChange);
        document.addEventListener('mozfullscreenchange', onFullScreenChange);
        document.addEventListener('webkitfullscreenchange', onFullScreenChange);
        document.addEventListener('MSFullscreenChange', onFullScreenChange);

        // 监听按钮事件
        document.getElementById('loadBtn').addEventListener('click', () => { virtualButtonManager.loadButtons(settings); });
        document.getElementById('editBtn').addEventListener('click', virtualButtonManager.toggleEditMode);
        document.getElementById('generateBtn').addEventListener('click', virtualButtonManager.generateButtons);
        document.getElementById('exportBtn').addEventListener('click', virtualButtonManager.exportButtons);
        document.getElementById('importBtn').addEventListener('click', virtualButtonManager.importButtons);
        document.getElementById('fullScreenBtn').addEventListener('click', () => {
            fullsc(0);
        });

        document.getElementById('fullScreenLandBtn').addEventListener('click', () => {
            window.game.width = screen.height;
            window.game.height = screen.width;
            fullsc(1);
        });

        screenCross = [screen.width / 2, screen.height / 2];

        settings = [
            { "key": "dpad", "left": "80px", "top": screenCross[1] + 100 + "px", "size": "120px" },
            { "key": "KeyA", "left": screenCross[0] + 50 + "px", "top": screenCross[1] + 100 + "px", "size": "50px" },
            { "key": "ControlLeft", "left": screenCross[0] + 50 + "px", "top": screenCross[1] + 160 + "px", "size": "50px" },
            { "key": "AltLeft", "left": screenCross[0] + 110 + "px", "top": screenCross[1] + 160 + "px", "size": "50px" }
        ]

        const iframe = document.getElementById('gameFrame');
        iframe.onload = function () {
            console.log('iframe加载完成');
            const iframeDocument = iframe.contentDocument;

            window.wrap = iframeDocument.getElementsByClassName("emscripten_border")[0]
            window.game = iframeDocument.getElementById('canvas');
            window.gl = game.getContext("webgl")
            virtualButtonManager.init(wrap);
        };   
    </script>

</body>

</html>